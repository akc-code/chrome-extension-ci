name: deploy-chrome-extension
on:
  release:
    types: [prereleased]
    branch: main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: main
      - name: install curl and jq zip unzip
        run: sudo apt-get update && sudo apt-get -y install curl jq
      - name: Package extension
        run: RETAIN_EXT_VERSION=$(cat manifest.json | jq -r .version) && ZIP_FN_PREFIX=${RETAIN_EXT_VERSION//./} && NMRT="${ZIP_FN_PREFIX}-chrome.zip" && zip -r $NMRT dist
      - name: Get the release info
        run: |
          echo "The tag_name in the version that triggered this release - '${{ github.event.release.tag_name }}' "
          echo "The version_name in the version that triggered this release - '${{ github.event.release.name }}' " 
          echo "The release notes - '${{ github.event.release.body }}' "

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
          architecture: x64

      - name: Set up Python dependencies
        run: pip install -r deployment_scripts/requirements.txt

      - name: publish Chrome extension to the web store
        run: python deployment_scripts/deploy-chrome-extension.py $RETAIN_EXT_CLIENT_ID $RETAIN_EXT_CLIENT_SECRET $RETAIN_EXT_REFRESH_TOKEN $APP_ID $NMRT
        env:
          RETAIN_EXT_CLIENT_ID: ${{ secrets.RETAIN_EXT_CLIENT_ID }}
          RETAIN_EXT_CLIENT_SECRET: ${{ secrets.RETAIN_EXT_CLIENT_SECRET }}
          RETAIN_EXT_REFRESH_TOKEN: ${{ secrets.RETAIN_EXT_REFRESH_TOKEN }}
          APP_ID: afblekficpcnoabgcdekljjfeekgjddp
